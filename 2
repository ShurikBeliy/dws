import PIL
import os

def add_suffix_to_filename(filename, suffix):
    """ Add prefix to image filename """
    path = os.path.splitext(filename)
    return ''.join(path[:1],suffix,'.',path[1:])

def change_filename_extension(filename, extension):
    """ Add prefix to image filename """
    path = os.path.splitext(filepath)
    return ''.join(path[:1],'.',extension)

def resize_image_to_width_and_return_pil_image(image, to_width):
    """ Resize image to width. Height will change accordingly. """
    print("55555")
    filepath = image.path
    image = PIL.Image.open(filepath)
    image = image.resize( ( to_width, round( image.height * ( to_width / image.width ) ) ) )
    return image

def convert_image_type_and_save(pil_image, image_type, webp_path):
    """ Convert image to new type and save with new path """
    webp = image.convert('RGB')
    webp.save(webp_path,image_type)

def get_image_url_by_type(image, image_type='webp', image_width=None):
    """ Get image url. If image doesn't exists it will try to create from original """
    print(222)
    image_path = change_filename_extension(image.path, image_type)
    print(image_path)
    if not os.path.exists(image_path):
        pli_image = PIL.Image.open(image.path)
        if image_width:
            print(image_width)
            pli_image = resize_image_to_width_and_return_pil_image(image, image_width)
        convert_image_type_and_save(pil_image, image_type, image_path)
    return change_filename_extension(image.url, image_type)

def create_and_get_webp_urls(image, need_retina):
    """ Generate image for retina and image that smaller 2 times if it necessary """
    print(1111)
    retina_image = get_image_url_by_type(image, 'webp', image.width )
    # if we don't need retina we will return original size image
    if not need_retina:
        return retina_image, None # just original size image

    # but if we need retina we will generate image that smaller 2 time than retina image
    image = get_image_url_by_type(image, 'webp', int(image.width/2) )
    return image, retina_image
